{
  final ITraceListProvider provider=new MockTraceListProvider();
  final MockDebugger debugger=new MockDebugger(new ModuleTargetSettings(module));
  final MockModule module=new MockModule();
  debugger.setAddressTranslator(module,new CAddress(0),new CAddress(0x1000));
  debugger.connect();
  final TraceLogger logger=new TraceLogger(provider,debugger);
  final MockTraceLoggerListener listener=new MockTraceLoggerListener();
  logger.addListener(listener);
  final MockSqlProvider sqlProvider=new MockSqlProvider();
  final TraceList trace=new TraceList(1,"Foo","Bar",sqlProvider);
  final Set<BreakpointAddress> addresses=new HashSet<BreakpointAddress>();
  addresses.add(new BreakpointAddress(module,new UnrelocatedAddress(new CAddress(0x100))));
  addresses.add(new BreakpointAddress(module,new UnrelocatedAddress(new CAddress(0x200))));
  logger.start(trace,addresses,3);
  final DebuggerSynchronizer m_synchronizer=(DebuggerSynchronizer)ReflectionHelpers.getField(AbstractDebugger.class,debugger,"synchronizer");
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1100))));
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1200))));
  assertEquals(2,trace.getEventCount());
  assertEquals("++",listener.events);
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1100))));
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1200))));
  assertEquals(4,trace.getEventCount());
  assertEquals("++",listener.events);
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1100))));
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1200))));
  assertEquals(6,trace.getEventCount());
  assertEquals("++--!",listener.events);
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1100))));
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1200))));
  assertEquals(6,trace.getEventCount());
  assertEquals("++--!",listener.events);
  logger.stop();
  assertEquals(6,trace.getEventCount());
  assertEquals("++--!",listener.events);
  logger.start(trace,addresses,1);
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1100))));
  m_synchronizer.receivedEvent(DebuggerMessageBuilder.buildEchoBreakpointHit(new RelocatedAddress(new CAddress(0x1200))));
  logger.stop();
  assertEquals(8,trace.getEventCount());
  debugger.close();
}
